/*
Copyright (c) 2008-2009, OpenGeo
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:

    * Redistributions of source code must retain the above copyright notice,
      this list of conditions and the following disclaimer.
    * Redistributions in binary form must reproduce the above copyright
      notice, this list of conditions and the following disclaimer in the
      documentation and/or other materials provided with the distribution.
    * Neither the name of the Open Planning Project nor the names
      of its contributors may be used to endorse or promote products derived
      from this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
POSSIBILITY OF SUCH DAMAGE.
*/

var GeoExplorer=Ext.extend(Ext.util.Observable,{map:null,layers:null,capabilities:null,mapPanel:null,legendPanel:null,toolbar:null,alignToGrid:false,capGrid:null,popupCache:null,layerSources:null,backgroundManager:null,addLayersButtonText:"UT:Add Layers",areaActionText:"UT:Area",backgroundContainerText:"UT:Background",capGridAddLayersText:"UT:Add Layers",capGridDoneText:"UT:Done",capGridText:"UT:Available Layers",connErrorTitleText:"UT:Connection Error",connErrorText:"UT:The server returned an error",connErrorDetailsText:"UT:Details...",exportDialogMessage:'<p> UT: Your map is ready to be published to the web! </p>'+'<p> Simply copy the following HTML to embed the map in your website: </p>',heightLabel:'UT: Height',infoButtonText:"UT:Get Feature Info",largeSizeLabel:'UT:Large',layerAdditionLabel:"UT: or add a new server.",layerContainerText:"UT:Map Layers",layerPropertiesText:'UT: Layer Properties',layerPropertiesTipText:'UT: Change layer metadata, format and style',layerSelectionLabel:"UT:View available data from:",layersContainerText:"UT:Data",layersPanelText:"UT:Layers",legendPanelText:"UT:Legend",lengthActionText:"UT:Length",mapSizeLabel:'UT: Map Size',measureSplitText:"UT:Measure",metaDataHeader:'UT:About this Map',metaDataMapAbstract:'UT:Abstract',metaDataMapContact:'UT:Contact',metaDataMapId:"UT:Permalink",metaDataMapTitle:'UT:Title',miniSizeLabel:'UT: Mini',navActionTipText:"UT:Pan Map",navNextAction:"UT:Zoom to Next Extent",navPreviousActionText:"UT:Zoom to Previous Extent",noPermalinkText:"UT: This map has not yet been saved.",permalinkLabel:'UT: Permalink',premiumSizeLabel:'UT: Premium',printTipText:"UT:Print Map",printWindowTitleText:"UT:Print Preview",propertiesText:"UT:Properties",publishActionText:'UT:Publish Map',removeLayerActionText:"UT:Remove Layer",removeLayerActionTipText:"UT:Remove Layer",saveFailMessage:"UT: Sorry, your map could not be saved.",saveFailTitle:"UT: Error While Saving",saveMapText:"UT: Save Map",saveNotAuthorizedMessage:"UT: You Must be logged in to save this map.",smallSizeLabel:'UT: Small',sourceLoadFailureMessage:'UT: Error contacting server.\n Please check the url and try again.',switchTo3DActionText:"UT:Switch to Google Earth 3D Viewer",unknownMapMessage:'UT: The map that you are trying to load does not exist.  Creating a new map instead.',unknownMapTitle:'UT: Unknown Map',unsupportedLayersTitleText:'UT:Unsupported Layers',unsupportedLayersText:'UT:The following layers cannot be printed:',widthLabel:'UT: Width',zoomInActionText:"UT:Zoom In",zoomOutActionText:"UT:Zoom Out",zoomSelectorText:'UT:Zoom level',zoomSliderTipText:"UT: Zoom Level",zoomToLayerExtentText:"UT:Zoom to Layer Extent",zoomVisibleButtonText:"UT:Zoom to Visible Extent",constructor:function(config){var query=Ext.urlDecode(document.location.search.substr(1));var queryConfig=Ext.util.JSON.decode(query.q);this.initialConfig=Ext.apply({},queryConfig,config);Ext.apply(this,this.initialConfig);this.mapID=this.initialConfig.id;this.addEvents(["ready","idchange"]);Ext.util.Observable.observeClass(Ext.data.Connection);Ext.data.Connection.on({"beforerequest":function(conn,options){if(this.proxy&&options.url.indexOf(this.proxy)!==0&&options.url.indexOf(this.rest)!==0){var url=Ext.urlAppend(options.url,Ext.urlEncode(options.params));delete options.params;options.url=this.proxy+encodeURIComponent(url);}},"requestexception":function(conn,response,options){if(options.failure){return;}
Ext.Msg.show({title:this.connErrorTitleText,msg:this.connErrorText+": "+response.status+" "+response.statusText,icon:Ext.MessageBox.ERROR,buttons:{ok:this.connErrorDetailsText,cancel:true},fn:function(result){if(result=="ok"){var details=new Ext.Window({title:response.status+" "+response.statusText,width:400,height:300,items:{xtype:"container",cls:"error-details",html:response.responseText},autoScroll:true,buttons:[{text:"OK",handler:function(){details.close()}}]});details.show();this.close();}}});},scope:this});Ext.form.ComboBox.prototype.getListParent=function(){return this.el.up(".x-window")||document.body;}
Ext.Window.prototype.shadow=false;OpenLayers.Renderer.defaultSymbolizer={fillColor:"#808080",fillOpacity:1,strokeColor:"#000000",strokeOpacity:1,strokeWidth:1,strokeDashstyle:"solid",pointRadius:3,graphicName:"square"};if(this.proxy){OpenLayers.ProxyHost=this.proxy;}
this.popupCache={};this.backgroundManager=new GeoExplorer.BackgroundLayerManager({proxy:this.proxy,backgroundLayers:this.backgroundLayers});this.load();},load:function(){this.layerSources=new Ext.data.SimpleStore({fields:["identifier","name","store","url"],data:[]});var dispatchQueue=[function(done){Ext.onReady(function(){this.createLayout();done();},this);}];for(var id in this.wms){dispatchQueue.push((function(id){return function(done){this.addSource(this.wms[id],id,done,done);};})(id));}
dispatchQueue=dispatchQueue.concat(this.backgroundManager.getBackgroundLoaders());gxp.util.dispatch(dispatchQueue,this.activate,this);},addSource:function(url,id,success,fail,scope){scope=scope||this;success=OpenLayers.Function.bind(success,scope);fail=OpenLayers.Function.bind(fail,scope);id=id||OpenLayers.Util.createUniqueID("source");var capsURL=this.createWMSCapabilitiesURL(url);var store=new GeoExt.data.WMSCapabilitiesStore();OpenLayers.Request.GET({proxy:this.proxy,url:capsURL,success:function(request){var store=new GeoExt.data.WMSCapabilitiesStore({fields:[{name:"name",type:"string"},{name:"abstract",type:"string"},{name:"queryable",type:"boolean"},{name:"formats"},{name:"styles"},{name:"bbox"},{name:"llbbox"},{name:"minScale"},{name:"maxScale"},{name:"prefix"},{name:"attribution"},{name:"keywords"},{name:"metadataURLs"},{name:"owsType"},{name:"group",type:"string"},{name:"source_id",type:"string"}]});store.on("load",function(store){this.describeLayers(store,url,record,success);},this);var xml=request.responseXML;var data=(xml&&xml.documentElement)?xml:request.responseText;var format=new OpenLayers.Format.WMSCapabilities();var extractedData=format.read(data);store.on("load",function(store){store.each(function(record){record.set("source_id",id);},this);});var record=new this.layerSources.recordType({url:url,store:store,identifier:id,name:(extractedData.service&&extractedData.service.title)||id});this.layerSources.add(record);try{store.loadData(data);}catch(err){OpenLayers.Console.error("Could not load source: "+url);fail();return;}},failure:function(){OpenLayers.Console.error("Couldn't get capabilities document for wms '"+id+"'.");fail();},scope:this});},describeLayers:function(store,url,sourceRecord,success){var layerNames=[];store.each(function(layer){if(layer.get("queryable")){layerNames.push(layer.get("name"));}});layerNames=layerNames.join(",");OpenLayers.Request.GET({proxy:this.proxy,url:this.createOWSUrl(url,{SERVICE:"WMS",REQUEST:"DescribeLayer",VERSION:"1.1.1",layers:layerNames}),success:function(request){var describeLayerStore=new GeoExt.data.WMSDescribeLayerStore();var annotateLayers=function(describeLayerStore){describeLayerStore.each(function(description){var layer=store.getAt(store.find("name",description.get("typeName")));layer.set("owsType",description.get("owsType"));},this);success(sourceRecord);};describeLayerStore.on("load",annotateLayers,this);var xml=request.responseXML;var data=(xml&&xml.documentElement)?xml:request.responseText;describeLayerStore.loadData(data);}});},createWMSCapabilitiesURL:function(url){return url.toLowerCase().indexOf("getcapabilities")==-1?this.createOWSUrl(url,{SERVICE:'WMS',REQUEST:'GetCapabilities'}):url;},createOWSUrl:function(url,params){var argIndex=url.indexOf("?");if(argIndex>-1){var search=url.substring(url.indexOf("?")+1);url=url.replace(search,Ext.urlEncode(Ext.apply(Ext.urlDecode(search),params)));}else{url=url+"?"+Ext.urlEncode(params);}
return url;},createLayout:function(){this.map=new OpenLayers.Map({allOverlays:true,projection:new OpenLayers.Projection("EPSG:900913"),displayProjection:new OpenLayers.Projection("EPSG:4326"),units:"m",maxResolution:156543.0339,maxExtent:new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),controls:[new OpenLayers.Control.Navigation(),new OpenLayers.Control.PanPanel(),new OpenLayers.Control.ZoomPanel(),new OpenLayers.Control.Attribution()]});var onDoubleClick=function(ctrl,evt){OpenLayers.Event.stop(evt?evt:window.event);};var controls=this.map.controls[1].controls;for(var i=0;i<controls.length;i++){OpenLayers.Event.observe(controls[i].panel_div,"dblclick",OpenLayers.Function.bind(onDoubleClick,this.map.controls[0],controls[i]));}
this.map.events.on({"preaddlayer":function(evt){if(evt.layer.mergeNewParams){var maxExtent=evt.layer.maxExtent;if(maxExtent)evt.layer.mergeNewParams({transparent:true,format:"image/png",tiled:true,tilesorigin:[maxExtent.left,maxExtent.bottom]});}},scope:this});var mapConfig=this.initialConfig.map||{};var center=mapConfig.center&&new OpenLayers.LonLat(mapConfig.center[0],mapConfig.center[1]).transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection("EPSG:900913"));this.mapPanel=new GeoExt.MapPanel({layout:"anchor",border:true,map:this.map,center:center,zoom:mapConfig.zoom,items:[new GeoExt.ZoomSlider({vertical:true,height:100,plugins:new GeoExt.ZoomSliderTip({template:"<div>"+this.zoomSliderTipText+": {zoom}<div>"})})]});this.mapPanel.add(this.createMapOverlay());this.layers=this.mapPanel.layers;var addLayerButton=new Ext.Button({tooltip:this.addLayersButtonText,disabled:true,iconCls:"icon-addlayers",handler:this.showCapabilitiesGrid,scope:this});this.on("ready",function(){addLayerButton.enable();});var removeLayerAction=new Ext.Action({text:this.removeLayerActionText,iconCls:"icon-removelayers",disabled:true,tooltip:this.removeLayerActionTipText,handler:function(){var node=layerTree.getSelectionModel().getSelectedNode();if(node&&node.layer){var layer=node.layer;var store=node.layerStore;var record=store.getAt(store.findBy(function(record){return record.get("layer")===layer;}));store.remove(record);removeLayerAction.disable();}}});var layerPropertiesAction=new Ext.Action({text:this.layerPropertiesText,iconCls:"icon-layerproperties",disabled:true,tooltip:this.layerPropertiesTipText,handler:function(){var cancel=function(){var originalLayer=backupRecord.get("layer");layer.mergeNewParams(originalLayer.params);layer.setOpacity(originalLayer.opacity||1);prop.close();}
var node=layerTree.getSelectionModel().getSelectedNode();if(node&&node.layer){var layer=node.layer;var store=node.layerStore;var record=store.getAt(store.findBy(function(record){return record.get("layer")===layer;}));var backupRecord=record.clone();var prop=new Ext.Window({title:"Properties: "+record.get("layer").name,width:280,autoHeight:true,items:[{xtype:"gx_wmslayerpanel",autoHeight:true,layerRecord:record,defaults:{style:"padding: 10px;",autoHeight:true,hideMode:"offsets"},buttons:[{text:"Cancel",handler:cancel},{text:"Save",handler:function(){prop.close();}}]}]});prop.items.get(0).items.get(0).cascade(function(i){i instanceof Ext.form.Field&&i.setDisabled(true);});prop.items.get(0).add(new gxp.WMSStylesDialog({title:"Styles",layerRecord:record,autoScroll:true,defaults:{defaults:{bubbleEvents:["add","remove","afterlayout"]}}}));prop.show();}}});var updateLayerAction=function(sm,node){var count=this.mapPanel.layers.queryBy(function(r){return!(r.get("layer")instanceof OpenLayers.Layer.Vector);}).getCount();removeLayerAction.setDisabled(count<=1);layerPropertiesAction.setDisabled(!(node.layer instanceof OpenLayers.Layer.WMS));};var bgSubTree=new GeoExt.tree.BaseLayerContainer({text:this.backgroundContainerText,allowDrag:false,layerStore:this.layers,loader:{filter:function(record){return record.get('group')==='background';}}});var fgSubTree=new GeoExt.tree.OverlayLayerContainer({text:this.layerContainerText,allowDrag:false,layerStore:this.layers,loader:{filter:function(record){return record.get('group')!=='background';}}});var treeRoot=new Ext.tree.TreeNode({allowDrop:false});treeRoot.appendChild(fgSubTree);treeRoot.appendChild(bgSubTree);var layerTree=new Ext.tree.TreePanel({border:false,rootVisible:false,loader:{applyLoader:false},root:treeRoot,enableDD:true,selModel:new Ext.tree.DefaultSelectionModel({listeners:{beforeselect:updateLayerAction,scope:this}}),listeners:{contextmenu:function(node,e){if(node&&node.layer){node.select();var c=node.getOwnerTree().contextMenu;c.contextNode=node;c.showAt(e.getXY());}},scope:this},contextMenu:new Ext.menu.Menu({items:[{text:this.zoomToLayerExtentText,iconCls:"icon-zoom-visible",handler:function(){var node=layerTree.getSelectionModel().getSelectedNode();if(node&&node.layer){this.map.zoomToExtent(node.layer.restrictedExtent);}},scope:this},removeLayerAction,layerPropertiesAction]})});var layersContainer=new Ext.Panel({autoScroll:true,border:false,title:this.layersContainerText,items:[layerTree],tbar:[addLayerButton,Ext.apply(new Ext.Button(removeLayerAction),{text:""})]});this.legendPanel=new GeoExt.LegendPanel({title:this.legendPanelText,border:false,hideMode:"offsets",split:true,autoScroll:true,ascending:false,map:this.map,defaults:{cls:'legend-item'}});var titleField=new Ext.form.TextField({width:'95%',disabled:true,fieldLabel:this.metaDataMapTitle,listeners:{'change':function(field,newValue,oldValue){this.about.title=newValue;},scope:this}});var contactField=new Ext.form.TextField({width:'95%',disabled:true,fieldLabel:this.metaDataMapContact,listeners:{'change':function(field,newValue,oldValue){this.about.contact=newValue;},scope:this}});var abstractField=new Ext.form.TextArea({width:'95%',disabled:true,fieldLabel:this.metaDataMapAbstract,listeners:{'change':function(field,newValue,oldValue){this.about["abstract"]=newValue;},scope:this}});var linkField=new Ext.form.TextField({width:'95%',disabled:true,fieldLabel:this.metaDataMapId,listeners:{scope:this}});var permalink=function(id){return window.location.protocol+"//"+
window.location.host+"/maps/"+id;};this.on("idchange",function(id){linkField.setValue(permalink(id));},this);var metaDataPanel=new Ext.FormPanel({bodyStyle:{padding:"5px"},autoScroll:true,collapsible:true,labelAlign:"top",items:[titleField,contactField,abstractField,linkField],title:this.metaDataHeader,height:250});this.on("ready",function(){titleField.setValue(this.about.title);contactField.setValue(this.about.contact);abstractField.setValue(this.about["abstract"]);if(!this.mapID){linkField.setValue(this.noPermalinkText);}else{linkField.setValue(permalink(this.mapID));}
metaDataPanel.enable();},this);var layersTabPanel=new Ext.TabPanel({border:false,deferredRender:false,items:[layersContainer,this.legendPanel],activeTab:0});var layersPanel=new Ext.Panel({title:this.layersPanelText,layout:"fit",items:[layersTabPanel]});var westPanel=new Ext.Container({layout:"accordion",layoutConfig:{animate:true},region:"west",width:250,split:true,collapsible:true,collapseMode:"mini",activeItem:1,items:[metaDataPanel,layersPanel]});this.toolbar=new Ext.Toolbar({disabled:true,items:this.createTools()});this.on("ready",function(){var disabled=this.toolbar.items.filterBy(function(item){return item.initialConfig&&item.initialConfig.disabled;});this.toolbar.enable();disabled.each(function(item){item.disable();});},this);this.googleEarthPanel=new GeoExplorer.GoogleEarthPanel({mapPanel:this.mapPanel});this.googleEarthPanel.on("show",function(){addLayerButton.disable();removeLayerAction.disable();layerTree.getSelectionModel().un("beforeselect",updateLayerAction,this);},this);this.googleEarthPanel.on("hide",function(){addLayerButton.enable();removeLayerAction.enable();layerTree.getSelectionModel().on("beforeselect",updateLayerAction,this);},this);this.mapPanelContainer=new Ext.Panel({layout:"card",region:"center",defaults:{border:false},items:[this.mapPanel,this.googleEarthPanel],activeItem:0});var header=new Ext.Panel({region:"north",autoHeight:true});header.on('render',function(){header.getEl().appendChild(Ext.get('app-header'));});var viewport=new Ext.Viewport({layout:"border",items:[header,{region:"center",xtype:"container",layout:"fit",hideBorders:true,items:{layout:"border",deferredRender:false,tbar:this.toolbar,items:[this.mapPanelContainer,westPanel]}}]});Lang.registerLinks();},activate:function(){if(this.mapid){this.fireevent('idchange',this.mapid);}
this.addLayers();Ext.QuickTips.init();this.fireEvent("ready");},addLayers:function(){var mapConfig=this.initialConfig.map;if(mapConfig&&mapConfig.layers){var records=[];for(var i=0;i<mapConfig.layers.length;++i){var conf=mapConfig.layers[i];var index=this.layerSources.find("identifier",conf.wms);if(index==-1){continue;}
var storeRecord=this.layerSources.getAt(index);var store=storeRecord.data.store;var id=store.find("name",conf.name);var record,layer;if(id>=0){Ext.data.Record.AUTO_ID++;record=store.getAt(id).copy(Ext.data.Record.AUTO_ID);layer=record.get("layer").clone();record.data.layer=layer;layer.restrictedExtent=OpenLayers.Bounds.fromArray(record.get("llbbox"));layer.restrictedExtent.transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection("EPSG:900913"));layer.maxExtent=layer.restrictedExtent;layer.visibility=("visibility"in conf)?conf.visibility:true;if(conf.title){layer.setName(conf.title);record.set("title",conf.title);}
record.set("group",conf.group);if(record.get("group")==="background"){records.unshift(record);}else{records.push(record);}}}
this.layers.add(records);if(this.mapPanel.center){this.map.setCenter(this.mapPanel.center,this.mapPanel.zoom);}else if(this.mapPanel.extent){this.map.zoomToExtent(this.mapPanel.extent);}else{this.map.zoomToMaxExtent();}}
this.layers.insert(0,this.backgroundManager.getBackgroundLayers());},initCapGrid:function(){var firstSource=this.layerSources.getAt(0);var capGridPanel=new GeoExplorer.CapabilitiesGrid({store:firstSource.data.store,mapPanel:this.mapPanel,expander:new GeoExplorer.CapabilitiesRowExpander({ows:firstSource.get("url")}),layout:'fit',region:'center',autoScroll:true,alignToGrid:this.alignToGrid,listeners:{rowdblclick:function(panel,index,evt){panel.addLayers();}}});var sourceComboBox=new Ext.form.ComboBox({store:this.layerSources,valueField:"identifier",displayField:"name",triggerAction:"all",editable:false,allowBlank:false,forceSelection:true,mode:"local",value:firstSource.data.identifier,listeners:{select:function(combo,record,index){capGridPanel.reconfigure(record.data.store,capGridPanel.getColumnModel());capGridPanel.expander.ows=record.get("url");},scope:this}});var capGridToolbar=null;if(this.proxy||this.layerSources.getCount()>1){capGridToolbar=[new Ext.Toolbar.TextItem({text:this.layerSelectionLabel}),sourceComboBox];}
if(this.proxy){capGridToolbar.push(new Ext.Button({text:this.layerAdditionLabel,handler:function(){newSourceWindow.show();}}));}
var newSourceWindow=new GeoExplorer.NewSourceWindow({modal:true});newSourceWindow.on("server-added",function(url){newSourceWindow.setLoading();var success=function(record){var index=this.layerSources.find("identifier",record.get("identifier"));sourceComboBox.onSelect(record,index);newSourceWindow.hide();};var failure=function(){newSourceWindow.setError(this.sourceLoadFailureMessage);};this.addSource(url,null,success,failure,this);},this);this.capGrid=new Ext.Window({title:this.capGridText,closeAction:'hide',layout:'border',height:300,width:600,modal:true,items:[capGridPanel],tbar:capGridToolbar,bbar:["->",new Ext.Button({text:this.capGridAddLayersText,iconCls:"icon-addlayers",handler:function(){capGridPanel.addLayers();},scope:this}),new Ext.Button({text:this.capGridDoneText,handler:function(){this.capGrid.hide();},scope:this})],listeners:{hide:function(win){capGridPanel.getSelectionModel().clearSelections();}}});},showCapabilitiesGrid:function(){if(!this.capGrid){this.initCapGrid();}
this.capGrid.show();},createMapOverlay:function(){var scaleLinePanel=new Ext.BoxComponent({width:100,height:42,autoEl:{tag:"div",cls:"olControlScaleLine overlay-element overlay-scaleline"}});scaleLinePanel.on('render',function(){var scaleLine=new OpenLayers.Control.ScaleLine({div:scaleLinePanel.getEl().dom});this.mapPanel.map.addControl(scaleLine);scaleLine.activate();},this);var zoomStore=new GeoExt.data.ScaleStore({map:this.mapPanel.map});var zoomSelector=new Ext.form.ComboBox({emptyText:'Zoom level',tpl:'<tpl for="."><div class="x-combo-list-item">1 : {[parseInt(values.scale)]}</div></tpl>',editable:false,triggerAction:'all',mode:'local',store:zoomStore,anchor:"100%",hideLabel:true});zoomSelector.on({click:function(evt){evt.stopEvent();},mousedown:function(evt){evt.stopEvent();},select:function(combo,record,index){this.mapPanel.map.zoomTo(record.data.level);},scope:this})
var zoomSelectorWrapper=new Ext.Container({items:[zoomSelector],cls:'overlay-element overlay-scalechooser',layout:"form",width:110});this.mapPanel.map.events.register('zoomend',this,function(){var scale=zoomStore.queryBy(function(record){return this.mapPanel.map.getZoom()==record.data.level;},this);if(scale.length>0){scale=scale.items[0];zoomSelector.setValue("1 : "+parseInt(scale.data.scale,10));}else{if(!zoomSelector.rendered){return;}
zoomSelector.clearValue();}});var mapOverlay=new Ext.Panel({cls:"map-overlay",layout:"hbox",autoHeight:true,width:225,items:[scaleLinePanel,zoomSelectorWrapper]});mapOverlay.on("afterlayout",function(){scaleLinePanel.getEl().dom.style.position='relative';scaleLinePanel.getEl().dom.style.display='inline';mapOverlay.getEl().on("click",function(x){x.stopEvent();});mapOverlay.getEl().on("mousedown",function(x){x.stopEvent();});},this);return mapOverlay;},createTools:function(){var toolGroup="toolGroup";var printButton=new Ext.Button({tooltip:this.printTipText,iconCls:"icon-print",handler:function(){var unsupportedLayers=[];var printWindow=new Ext.Window({title:this.printWindowTitleText,modal:true,border:false,resizable:false});printWindow.add(new GeoExt.ux.PrintPreview({mapTitle:this.about["title"],comment:this.about["abstract"],printMapPanel:{map:{controls:[new OpenLayers.Control.Navigation(),new OpenLayers.Control.PanPanel(),new OpenLayers.Control.ZoomPanel(),new OpenLayers.Control.Attribution()],eventListeners:{"preaddlayer":function(evt){if(evt.layer instanceof OpenLayers.Layer.Google){unsupportedLayers.push(evt.layer.name);return false;}},scope:this}},items:[{xtype:"gx_zoomslider",vertical:true,height:100,aggressive:true}]},printProvider:{capabilities:window.printCapabilities,listeners:{"beforeprint":function(){printWindow.items.get(0).printMapPanel.layers.each(function(l){var params=l.get("layer").params;for(var p in params){if(params[p]instanceof Array){params[p]=params[p].join(",");}}})},"print":function(){printWindow.close();}}},includeLegend:true,sourceMap:this.mapPanel,legend:this.legendPanel}));printWindow.show();printWindow.setWidth(0);var tb=printWindow.items.get(0).items.get(0);var w=0;tb.items.each(function(item){if(item.getEl()){w+=item.getWidth();}});printWindow.setWidth(Math.max(printWindow.items.get(0).printMapPanel.getWidth(),w+20));printWindow.center();unsupportedLayers.length&&Ext.Msg.alert(this.unsupportedLayersTitleText,this.unsupportedLayersText+"<ul><li>"+unsupportedLayers.join("</li><li>")+"</li></ul>");},scope:this});var navAction=new GeoExt.Action({tooltip:this.navActionTipText,iconCls:"icon-pan",enableToggle:true,pressed:true,allowDepress:false,control:new OpenLayers.Control.Navigation(),map:this.map,toggleGroup:toolGroup});var historyControl=new OpenLayers.Control.NavigationHistory();this.map.addControl(historyControl);var navPreviousAction=new GeoExt.Action({tooltip:this.navPreviousActionText,iconCls:"icon-zoom-previous",disabled:true,control:historyControl.previous});var navNextAction=new GeoExt.Action({tooltip:this.navNextAction,iconCls:"icon-zoom-next",disabled:true,control:historyControl.next});var info={controls:[]};var infoButton=new Ext.Button({tooltip:this.infoButtonText,iconCls:"icon-getfeatureinfo",toggleGroup:toolGroup,enableToggle:true,allowDepress:false,toggleHandler:function(button,pressed){for(var i=0,len=info.controls.length;i<len;i++){if(pressed){info.controls[i].activate();}else{info.controls[i].deactivate();}}}});var updateInfo=function(){var queryableLayers=this.mapPanel.layers.queryBy(function(x){return x.get("queryable");});var map=this.mapPanel.map;var control;for(var i=0,len=info.controls.length;i<len;i++){control=info.controls[i];control.deactivate();control.destroy();}
info.controls=[];queryableLayers.each(function(x){var control=new OpenLayers.Control.WMSGetFeatureInfo({url:x.get("layer").url,queryVisible:true,layers:[x.get("layer")],eventListeners:{getfeatureinfo:function(evt){this.displayPopup(evt,x.get("title")||x.get("name"));},scope:this}});map.addControl(control);info.controls.push(control);if(infoButton.pressed){control.activate();}},this);};this.mapPanel.layers.on("update",updateInfo,this);this.mapPanel.layers.on("add",updateInfo,this);this.mapPanel.layers.on("remove",updateInfo,this);var activeIndex=0;var measureSplit=new Ext.SplitButton({iconCls:"icon-measure-length",tooltip:this.measureSplitText,enableToggle:true,toggleGroup:toolGroup,allowDepress:false,handler:function(button,event){if(!button.pressed){button.toggle();}else{button.menu.items.itemAt(activeIndex).setChecked(true);}},listeners:{toggle:function(button,pressed){if(!pressed){button.menu.items.each(function(i){i.setChecked(false);});}},render:function(button){Ext.ButtonToggleMgr.register(button);}},menu:new Ext.menu.Menu({items:[new Ext.menu.CheckItem(new GeoExt.Action({text:this.lengthActionText,iconCls:"icon-measure-length",map:this.map,toggleGroup:toolGroup,group:toolGroup,allowDepress:false,map:this.map,control:this.createMeasureControl(OpenLayers.Handler.Path,"Length")})),new Ext.menu.CheckItem(new GeoExt.Action({text:this.areaActionText,iconCls:"icon-measure-area",map:this.map,toggleGroup:toolGroup,group:toolGroup,allowDepress:false,map:this.map,control:this.createMeasureControl(OpenLayers.Handler.Polygon,"Area")}))]})});measureSplit.menu.items.each(function(item,index){item.on({checkchange:function(item,checked){measureSplit.toggle(checked);if(checked){activeIndex=index;measureSplit.setIconClass(item.iconCls);}}});});var enable3DButton=new Ext.Button({iconCls:"icon-3D",tooltip:this.switchTo3DActionText,enableToggle:true,toggleHandler:function(button,state){if(state===true){this.mapPanelContainer.getLayout().setActiveItem(1);this.toolbar.disable();button.enable();}else{this.mapPanelContainer.getLayout().setActiveItem(0);this.toolbar.enable();}},scope:this});var tools=[new Ext.Button({tooltip:this.saveMapText,handler:this.saveMap,scope:this,iconCls:"icon-save"}),window.printCapabilities?printButton:"",new Ext.Button({handler:function(){this.map.zoomIn();},tooltip:this.zoomInActionText,iconCls:"icon-zoom-in",scope:this}),new Ext.Button({tooltip:this.zoomOutActionText,handler:function(){this.map.zoomOut();},iconCls:"icon-zoom-out",scope:this}),navPreviousAction,navNextAction,new Ext.Button({tooltip:this.zoomVisibleButtonText,iconCls:"icon-zoom-visible",handler:function(){var extent,layer;for(var i=0,len=this.map.layers.length;i<len;++i){layer=this.map.layers[i];if(layer.getVisibility()){if(extent){extent.extend(layer.maxExtent);}else{extent=layer.maxExtent.clone();}}}
if(extent){this.map.zoomToExtent(extent);}},scope:this}),new Ext.Action({tooltip:this.publishActionText,handler:this.makeExportDialog,scope:this,iconCls:'icon-export'}),enable3DButton];return tools;},createMeasureControl:function(handlerType,title){var styleMap=new OpenLayers.StyleMap({"default":new OpenLayers.Style(null,{rules:[new OpenLayers.Rule({symbolizer:{"Point":{pointRadius:4,graphicName:"square",fillColor:"white",fillOpacity:1,strokeWidth:1,strokeOpacity:1,strokeColor:"#333333"},"Line":{strokeWidth:3,strokeOpacity:1,strokeColor:"#666666",strokeDashstyle:"dash"},"Polygon":{strokeWidth:2,strokeOpacity:1,strokeColor:"#666666",fillColor:"white",fillOpacity:0.3}}})]})});var cleanup=function(){if(measureToolTip){measureToolTip.destroy();}};var makeString=function(metricData){var metric=metricData.measure;var metricUnit=metricData.units;measureControl.displaySystem="english";var englishData=metricData.geometry.CLASS_NAME.indexOf("LineString")>-1?measureControl.getBestLength(metricData.geometry):measureControl.getBestArea(metricData.geometry);var english=englishData[0];var englishUnit=englishData[1];measureControl.displaySystem="metric";var dim=metricData.order==2?'<sup>2</sup>':'';return metric.toFixed(2)+" "+metricUnit+dim+"<br>"+
english.toFixed(2)+" "+englishUnit+dim;};var measureToolTip;var measureControl=new OpenLayers.Control.Measure(handlerType,{persist:true,handlerOptions:{layerOptions:{styleMap:styleMap}},eventListeners:{measurepartial:function(event){cleanup();measureToolTip=new Ext.ToolTip({target:Ext.getBody(),html:makeString(event),title:title,autoHide:false,closable:true,draggable:false,mouseOffset:[0,0],showDelay:1,listeners:{hide:cleanup}});if(event.measure>0){var px=measureControl.handler.lastUp;var p0=this.mapPanel.getPosition();measureToolTip.targetXY=[p0[0]+px.x,p0[1]+px.y];measureToolTip.show();}},measure:function(event){cleanup();measureToolTip=new Ext.ToolTip({target:Ext.getBody(),html:makeString(event),title:title,autoHide:false,closable:true,draggable:false,mouseOffset:[0,0],showDelay:1,listeners:{hide:function(){measureControl.cancel();cleanup();}}});},deactivate:cleanup,scope:this}});return measureControl;},makeExportDialog:function(){new ExportWizard({map:this.mapID}).show();},extractConfiguration:function(){var center=this.map.getCenter().transform(new OpenLayers.Projection("EPSG:900913"),new OpenLayers.Projection("EPSG:4326"));var config={wms:{},map:{center:[center.lon,center.lat],zoom:this.map.zoom,layers:[]},about:Ext.apply({},this.about)};this.layerSources.each(function(record){config.wms[record.get("identifier")]=record.get("url");});this.layers.each(function(layerRecord){var layer=layerRecord.get('layer');var index=this.layerSources.find("identifier",layerRecord.get("source_id"))
if(layer.displayInLayerSwitcher&&index>=0){var source=this.layerSources.getAt(index);if(source===null){OpenLayers.Console.error("Could not find source for layer '"+layerRecord.get("name")+"'");return;}
config.map.layers.push({name:layerRecord.get("name"),title:layerRecord.get("title"),visibility:layer.getVisibility(),group:layerRecord.get("group"),wms:source.get("identifier")});}},this);return config;},updateURL:function(){return this.rest+this.mapID+'/data';},saveMap:function(){var config=this.extractConfiguration();var failure=function(response,options){var failureMessage=this.saveFailMessage;if(response.status==401){failureMessage=this.saveNotAuthorizedMessage;}
new Ext.Window({title:this.saveFailTitle,html:failureMessage}).show();};if(!this.mapID){Ext.Ajax.request({url:this.rest,method:'POST',jsonData:config,success:function(response,options){var id=response.getResponseHeader("Location");id=id.replace(/^\s*/,'');id=id.replace(/\s*$/,'');id=id.match(/[\d]*$/)[0];this.fireEvent("idchange",id);this.mapID=id;},failure:failure,scope:this});}
else{Ext.Ajax.request({url:this.updateURL(),method:'PUT',jsonData:config,success:function(response,options){},failure:failure,scope:this});}}});Ext.namespace("GeoNode");GeoNode.DataGrid=Ext.extend(Ext.util.Observable,{dataTitleHeaderText:"UT:Title",dataNameHeaderText:"UT:Name",dataDetailText:'UT: Click here for more information about this layer.',constructor:function(config){Ext.apply(this,config);this.loadData();},owsURL:function(params){var url=this.ows+'?'+Ext.urlEncode(params);if(this.proxy){url=this.proxy+'?'+Ext.urlEncode({"url":url});}
return url;},loadData:function(){var url=this.owsURL({'service':'WMS','request':'GetCapabilities'});this.capabilities=new GeoExt.data.WMSCapabilitiesStore({url:url,fields:[{name:"name",type:"string"},{name:"abstract",type:"string"},{name:"queryable",type:"boolean"},{name:"formats"},{name:"styles"},{name:"llbbox"},{name:"minScale"},{name:"maxScale"},{name:"prefix"},{name:"attribution"},{name:"keywords"},{name:"metadataURLs"},{name:"owsType"}]});gxp.util.dispatch([function(done){this.capabilities.load({callback:done,scope:this});}],this.doLayout,this);},doLayout:function(){var expanderTemplate='<p><b>'+GeoExplorer.CapabilitiesRowExpander.prototype.abstractText+'</b> {abstract}</p>'+'<p><b>'+GeoExplorer.CapabilitiesRowExpander.prototype.attributionText+'</b> {attribution:this.attributionLink}</p>'+'<p><b>'+GeoExplorer.CapabilitiesRowExpander.prototype.metadataText+'</b> {metadataURLs:this.metadataLinks}</p>'+'<p><b>'+GeoExplorer.CapabilitiesRowExpander.prototype.keywordText+'</b> {keywords:this.keywordList}</p>'+'<p><b>'+GeoExplorer.CapabilitiesRowExpander.prototype.downloadText+'</b> '+'<a class="download pdf" href="{name:this.pdfUrl}">PDF</a>, '+'<a class="download kml" href="{name:this.kmlUrl}">KML</a>, '+'<a class="download geotiff" href="{name:this.geoTiffUrl}">GeoTIFF</a>'+'<span class="{owsType:this.showWFS}">, '+'<a class="download shp" href="{name:this.shpUrl}">SHP (ZIP)</a>'+'</span>'+'</p>'+'<p><a href="/data/{name}">'+this.dataDetailText+'</a></p>';var expander=new GeoExplorer.CapabilitiesRowExpander({tpl:new Ext.Template(expanderTemplate),ows:this.ows});new Ext.grid.GridPanel({store:this.capabilities,plugins:[expander],columns:[expander,{header:this.dataTitleHeaderText,dataIndex:'title'},{header:this.dataNameHeaderText,dataIndex:'name'}],viewConfig:{autoFill:true},height:300,renderTo:this.renderTo})}});Lang={registerLinks:function(){var languages={'#spanish':'es','#english':'en'};for(var id in languages){var domNode=Ext.DomQuery.selectNode(id);if(domNode){domNode.onclick=(function(langcode){return function(){(new Ext.state.CookieProvider).set("locale",langcode);window.location.reload();return false;};})(languages[id]);}}}};Ext.onReady(Lang.registerLinks);Embed=Ext.extend(GeoExplorer,{zoomLevelText:"UT:Zoom Level: {zoom}",useToolbar:true,createLayout:function(){this.map=new OpenLayers.Map({allOverlays:true,projection:new OpenLayers.Projection("EPSG:900913"),displayProjection:new OpenLayers.Projection("EPSG:4326"),units:"m",maxResolution:156543.0339,maxExtent:new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),controls:[new OpenLayers.Control.PanPanel(),new OpenLayers.Control.ZoomPanel()]});var onDoubleClick=function(ctrl,evt){OpenLayers.Event.stop(evt?evt:window.event);};var controls=this.map.controls[0].controls;for(var i=0;i<controls.length;i++){OpenLayers.Event.observe(controls[i].panel_div,"dblclick",OpenLayers.Function.bind(onDoubleClick,this.map.controls[0],controls[i]));}
this.map.events.on({"preaddlayer":function(evt){if(evt.layer.mergeNewParams){var maxExtent=evt.layer.maxExtent;if(maxExtent)evt.layer.mergeNewParams({transparent:true,format:"image/png",tiled:true,tilesorigin:[maxExtent.left,maxExtent.bottom]});}},scope:this});var mapConfig=this.initialConfig.map||{};var center=mapConfig.center&&new OpenLayers.LonLat(mapConfig.center[0],mapConfig.center[1]).transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection("EPSG:900913"));this.mapPanel=new GeoExt.MapPanel({layout:"anchor",border:true,region:"center",map:this.map,center:center,zoom:mapConfig.zoom,items:[{xtype:"gx_zoomslider",vertical:true,height:100,plugins:new GeoExt.ZoomSliderTip({template:"<div>"+this.zoomLevelText+"</div>"})}]});this.mapPanel.add(this.createMapOverlay());this.layers=this.mapPanel.layers;var toolbar;if(this.useToolbar){toolbar=new Ext.Toolbar({xtype:"toolbar",region:"north",disabled:true,items:this.createTools()});this.on("ready",function(){toolbar.enable();});}
this.mapPanel.map.addControl(new OpenLayers.Control.Navigation());var viewportConfig=Ext.applyIf({layout:"fit",hideBorders:true,tbar:toolbar,items:{layout:"border",deferredRender:false,items:[this.mapPanel]}},this.view);var viewport=new this.view.type(viewportConfig);}});LayerPreview=Ext.extend(Embed,{setPreviewStyle:function(stylename){function isPreviewedLayer(rec){var index=this.layerSources.find("identifier",rec.get("source_id"))
return index!=-1;}
var layerIndex=this.layers.findBy(isPreviewedLayer,this);if(layerIndex!=-1){this.layers.getAt(layerIndex).get("layer").mergeNewParams({"styles":stylename});}},createTools:function(){var backgroundTree=new GeoExt.tree.BaseLayerContainer({text:this.backgroundContainerText,layerStore:this.layers,loader:{filter:function(record){return record.get('group')==='background';}}});return[{text:this.backgroundContainerText,menu:new Ext.menu.Menu({items:[new Ext.tree.TreePanel({border:false,rootVisible:false,loader:{applyLoader:false},root:backgroundTree})]})}];}});var ExportWizard=Ext.extend(Ext.Window,{exportDialogMessage:'<p> UT: Your map is ready to be published to the web! </p>'+'<p> Simply copy the following HTML to embed the map in your website: </p>',heightLabel:'UT: Height',largeSizeLabel:'UT: Large',mapSizeLabel:'UT: Map Size',miniSizeLabel:'UT: Mini',premiumSizeLabel:'UT: Premium',publishActionText:'UT:Publish Map',smallSizeLabel:'UT: Small',widthLabel:'UT: Width',initComponent:function(config){var description=new Ext.Panel({cls:'gx-wizard-description',html:this.exportDialogMessage,border:false});var snippetArea=new Ext.form.TextArea({height:'100',selectOnFocus:true,enableKeyEvents:true,listeners:{keypress:function(area,evt){evt.stopEvent();}}});var heightField=new Ext.form.NumberField({width:50,value:400});var widthField=new Ext.form.NumberField({width:50,value:600});var updateSnippet=function(){var query=Ext.urlEncode({map:this.map});var pathname=window.location.pathname.replace(/\/[^\/]*$/,'/embed.html');var url=window.location.protocol+"//"+
window.location.host+
pathname+"?"+query;snippetArea.setValue('<iframe height="'+heightField.getValue()+' " width="'+widthField.getValue()+'" src="'+url+'"> </iframe>');};heightField.on("change",updateSnippet,this);widthField.on("change",updateSnippet,this);var snippet=new Ext.Panel({border:false,layout:'fit',cls:'gx-snippet-area',items:[snippetArea]});var adjustments=new Ext.Panel({layout:"column",items:[new Ext.Panel({border:false,width:90,items:[new Ext.form.ComboBox({editable:false,width:70,store:new Ext.data.SimpleStore({fields:["name","height","width"],data:[[this.miniSizeLabel,100,100],[this.smallSizeLabel,200,300],[this.largeSizeLabel,400,600],[this.premiumSizeLabel,600,800]]}),triggerAction:'all',displayField:'name',value:this.largeSizeLabel,mode:'local',listeners:{'select':function(combo,record,index){widthField.setValue(record.get("width"));heightField.setValue(record.get("height"));updateSnippet.call(this);},scope:this}})]}),{cls:'gx-field-label',html:this.heightLabel,border:false},heightField,{cls:'gx-field-label',html:this.widthLabel,border:false},widthField],border:false});Ext.apply(this,{cls:'gx-wizard-pane',border:false,modal:true,title:this.publishActionText,height:'auto',width:500,items:[description,snippet,{cls:'gx-field-label',html:this.mapSizeLabel,border:false},adjustments]});ExportWizard.superclass.initComponent.call(this);this.on('show',updateSnippet);}});GeoExplorer.BackgroundLayerManager=Ext.extend(Ext.util.Observable,{backgroundQueue:null,backgroundLayers:null,backgroundDisabledText:"UT: No background",constructor:function(config){this.initialConfig=config;Ext.apply(this,this.initialConfig);this.backgroundQueue=[];},getBackgroundLoaders:function(){var loaders=[];var proxy=this.proxy;function mungeSourcePlugin(conf){var ptype="service"in conf?"gx-"+conf.service+"source":"gx-wmssource";var pluginConfig={"ptype":ptype};Ext.apply(pluginConfig,conf);if(proxy!==undefined&&"url"in pluginConfig&&pluginConfig.url.startsWith("http")){pluginConfig.url=proxy+escape(pluginConfig.url);}
delete pluginConfig.service;delete pluginConfig.layers;return pluginConfig;}
function backgroundLayerAdder(source,conf){return function(done){source.on({"ready":done,"scope":this});source.init(this);}}
for(var i=0,len=this.backgroundLayers.length;i<len;i++){var conf=this.backgroundLayers[i];var pluginConf=mungeSourcePlugin(conf);var source=Ext.ComponentMgr.createPlugin(pluginConf,"gx-wmssource");this.backgroundQueue.push({"source":source,"conf":conf});loaders.push(backgroundLayerAdder(source,conf));}
return loaders;},getBackgroundLayers:function(){var bglayers=[]
var visible=true;for(var i=0,len=this.backgroundQueue.length;i<len;i++){var source=this.backgroundQueue[i].source;var layers=this.backgroundQueue[i].conf.layers;for(var j=0,jlen=layers.length;j<jlen;j++){var conf=layers[j];if((typeof conf)==="string")conf={"name":conf};conf.isBaseLayer=true;conf.visibility=visible;var layer=source.createLayerRecord(conf);layer.set("group","background");layer.get("layer").visibility=visible;visible=false;bglayers.push(layer);}}
bglayers.push(new GeoExt.data.LayerRecord({title:this.backgroundDisabledText,layer:new OpenLayers.Layer(this.backgroundDisabledText,{'visibility':false}),group:"background",queryable:'false'}));return bglayers;}});Ext.namespace("GeoExplorer");GeoExplorer.GoogleEarthPanel=Ext.extend(Ext.Panel,{HORIZONTAL_FIELD_OF_VIEW:(30*Math.PI)/180,map:null,mapPanel:null,layers:null,earth:null,projection:null,layerCache:null,initComponent:function(){GeoExplorer.GoogleEarthPanel.superclass.initComponent.call(this);if(!this.map){this.map=this.mapPanel&&this.mapPanel.map;}
if(!this.layers){this.layers=this.mapPanel&&this.mapPanel.layers;}
this.projection=new OpenLayers.Projection("EPSG:4326");this.on("show",function(){this.layerCache={};google.earth.createInstance(this.body.dom,this.onEarthReady.createDelegate(this),function(){});},this);this.on("hide",function(){if(this.earth!=null){this.updateMap();this.body.child("*").remove();}
this.earth=null;},this);},onEarthReady:function(object){this.earth=object;this.earth.getOptions().setFlyToSpeed(this.earth.SPEED_TELEPORT);this.resetCamera();this.setExtent(this.map.getExtent());this.earth.getNavigationControl().setVisibility(this.earth.VISIBILITY_SHOW);var screenXY=this.earth.getNavigationControl().getScreenXY();screenXY.setXUnits(this.earth.UNITS_PIXELS);screenXY.setYUnits(this.earth.UNITS_INSET_PIXELS);this.earth.getWindow().setVisibility(true);this.layers.each(function(record){this.addLayer(record);},this);this.layers.on("remove",this.updateLayers,this);this.layers.on("update",this.updateLayers,this);this.layers.on("add",this.updateLayers,this);},updateLayers:function(){if(!this.earth)return;var features=this.earth.getFeatures();var f=features.getFirstChild();while(f!=null){features.removeChild(f);f=features.getFirstChild();}
this.layers.each(function(record){this.addLayer(record);},this);},addLayer:function(layer,order){if(this.earth){var name=layer.get("layer").id;if(this.layerCache[name]){var networkLink=this.layerCache[name];}else{var link=this.earth.createLink('kl_'+name);var ows=layer.get("layer").url;ows=ows.replace(/\?.*/,'');var kmlPath='/kml?mode=refresh&layers='+layer.get("layer").params.LAYERS;link.setHref(ows+kmlPath);var networkLink=this.earth.createNetworkLink('nl_'+name);networkLink.setName(name);networkLink.set(link,false,false);this.layerCache[name]=networkLink;}
networkLink.setVisibility(layer.get("layer").getVisibility());if(order!==undefined&&order<this.earth.getFeatures().getChildNodes().getLength())
{this.earth.getFeatures().insertBefore(this.earth.getFeatures().getChildNodes().item(order));}else{this.earth.getFeatures().appendChild(networkLink);}}},setExtent:function(extent){var extent=extent.transform(this.map.getProjectionObject(),this.projection);var center=extent.getCenterLonLat();var width=this.getExtentWidth(extent);var height=width/(2*Math.tan(this.HORIZONTAL_FIELD_OF_VIEW));var lookAt=this.earth.getView().copyAsLookAt(this.earth.ALTITUDE_RELATIVE_TO_GROUND);lookAt.setLatitude(center.lat);lookAt.setLongitude(center.lon);lookAt.setRange(height);this.earth.getView().setAbstractView(lookAt);},resetCamera:function(){var camera=this.earth.getView().copyAsCamera(this.earth.ALTITUDE_RELATIVE_TO_GROUND);camera.setRoll(0);camera.setHeading(0);camera.setTilt(0);this.earth.getView().setAbstractView(camera);},getExtent:function(){var geBounds=this.earth.getView().getViewportGlobeBounds();var olBounds=new OpenLayers.Bounds(geBounds.getWest(),geBounds.getSouth(),geBounds.getEast(),geBounds.getNorth());return olBounds;},updateMap:function(){var lookAt=this.earth.getView().copyAsLookAt(this.earth.ALTITUDE_RELATIVE_TO_GROUND);var center=this.reprojectToMap(new OpenLayers.LonLat(lookAt.getLongitude(),lookAt.getLatitude()));var geExtent=this.reprojectToMap(this.getExtent());this.map.zoomToExtent(geExtent,true);this.map.setCenter(center);var lookAt=this.earth.getView().copyAsLookAt(this.earth.ALTITUDE_RELATIVE_TO_GROUND);var height=lookAt.getRange();var width=2*height*Math.tan(this.HORIZONTAL_FIELD_OF_VIEW);var nextResolution=this.map.getResolutionForZoom(this.map.getZoom()+1);var currentExtent=this.map.getExtent();var nextExtent=new OpenLayers.Bounds(center.lon-(this.map.getSize().w/2*nextResolution),center.lat+(this.map.getSize().h/2*nextResolution),center.lon+(this.map.getSize().w/2*nextResolution),center.lat-(this.map.getSize().h/2*nextResolution));var currentWidthDiff=Math.abs(this.getExtentWidth(currentExtent)-width);var nextWidthDiff=Math.abs(this.getExtentWidth(nextExtent)-width);if(nextWidthDiff<currentWidthDiff){this.map.zoomTo(this.map.getZoom()+1);}},getExtentWidth:function(extent){var center=extent.getCenterLonLat();var middleLeft=new OpenLayers.LonLat(extent.left,center.lat);var middleRight=new OpenLayers.LonLat(extent.right,center.lat);return OpenLayers.Util.distVincenty(middleLeft,middleRight)*1000;},reprojectToGE:function(data){return data.clone().transform(this.map.getProjectionObject(),this.projection);},reprojectToMap:function(data){return data.clone().transform(this.projection,this.map.getProjectionObject());}});Ext.namespace("GeoExplorer");GeoExplorer.CapabilitiesRowExpander=Ext.extend(Ext.grid.RowExpander,{ows:null,abstractText:"UT:Abstract:",attributionEmptyText:"UT: No attribution information is provided for this layer.",attributionText:"UT:Provided by:",downloadText:"UT:Download:",keywordEmptyText:"UT: No keywords are listed for this layer.",keywordText:"UT:Keywords:",metadataEmptyText:'UT: No metadata URLs are defined for this layer.',metadataText:"UT:Metadata Links:",constructor:function(config){config.tpl=config.tpl||this.getDefaultTemplate();var expander,templateLib;expander=this;this.ows=config.ows;templateLib=Ext.apply({ows:function(){return expander.ows;}},this.templateLibrary);templateLib.metadataEmptyText=this.metadataEmptyText;templateLib.keywordEmptyText=this.keywordEmptyText;templateLib.attributionEmptyText=this.attributionEmptyText;Ext.apply(config.tpl,templateLib);GeoExplorer.CapabilitiesRowExpander.superclass.constructor.call(this,config);},getDefaultTemplate:function(){return new Ext.Template('<p><b>'+this.abstractText+'</b> {abstract}</p>'+'<p><b>'+this.attributionText+'</b> {attribution:this.attributionLink}</p>'+'<p><b>'+this.metadataText+'</b> {metadataURLs:this.metadataLinks}</p>'+'<p><b>'+this.keywordText+'</b> {keywords:this.keywordList}</p>'+'<p><b>'+this.downloadText+'</b> '+'<a class="download pdf" href="{name:this.pdfUrl}">PDF</a>, '+'<a class="download kml" href="{name:this.kmlUrl}">KML</a>, '+'<a class="download geotiff" href="{name:this.geoTiffUrl}">GeoTIFF</a>'+'<span class="{owsType:this.showWFS}">, '+'<a class="download shp" href="{name:this.shpUrl}">SHP (ZIP)</a>'+'</span>'+'</p>');},templateLibrary:{wmsParams:function(name,values,aspect){aspect=aspect||(8.5/11);var dx,dy,dataAspect,widthAdjust,heightAdjust;dx=values.llbbox[2]-values.llbbox[0];dy=values.llbbox[3]-values.llbbox[1];dataAspect=dx/dy;widthAdjust=1;heightAdjust=1;if(dataAspect>aspect){heightAdjust=dataAspect/aspect;}else{widthAdjust=aspect/dataAspect;}
return{service:"wms",request:"GetMap",bbox:this.adjustBounds(widthAdjust,heightAdjust,values.llbbox).toString(),layers:name,srs:"EPSG:4326",width:425,height:550};},adjustBounds:function(widthAdjust,heightAdjust,bbox){var dx,dy,midx,midy;dx=bbox[2]-bbox[0];dy=bbox[3]-bbox[1];midx=(bbox[2]+bbox[0])/2;midy=(bbox[3]+bbox[1])/2;return[midx-(widthAdjust*dx)/2,midy-(heightAdjust*dy)/2,midx+(widthAdjust*dx)/2,midy+(heightAdjust*dy)/2];},wfsParams:function(name,values){return{service:"wfs",request:"GetFeature",typeName:name};},showWFS:function(owsType,values){return owsType==="WFS"?"":"nodisplay";},shpUrl:function(name,values){var shpParams=Ext.apply(this.wfsParams(name,values),{outputFormat:'SHAPE-ZIP'});return this.ows()+"?"+Ext.urlEncode(shpParams);},pdfUrl:function(name,values){var pdfParams=Ext.apply(this.wmsParams(name,values),{format:'application/pdf'});return this.ows()+"?"+Ext.urlEncode(pdfParams);},kmlUrl:function(name,values){var kmlParams=Ext.apply(this.wmsParams(name,values),{format:'application/vnd.google-earth.kmz+xml',height:2048,width:2048},1);return this.ows()+"?"+Ext.urlEncode(kmlParams);},geoTiffUrl:function(name,values){var geoTiffParams=Ext.apply(this.wmsParams(name,values),{format:"image/geotiff"});return this.ows()+"?"+Ext.urlEncode(geoTiffParams);},metadataLinks:function(metadataURLs,values){if(metadataURLs===null||metadataURLs.length===0)
{return"<em>"+this.metadataEmptyText+"</em>";}else{var i,links,len;links=[];for(i=0,len=metadataURLs.length;i<len;i++){links.push("<a href=\""+metadataURLs[i].href+"\"> "+
metadataURLs[i].type+"</a>");}
return links.join(", ");}},keywordList:function(keywords,values){if(keywords===null||keywords.length===0)
{return"<em>"+this.keywordEmptyText+"</em>";}else{return keywords.join(", ");}},attributionLink:function(attribution,values){if(attribution==null||attribution.href==null){return"<em>"+this.attributionEmptyText+"</em>";}else{return"<a href=\""+attribution.href+"\"> "+attribution.title+"</a>";}}}});var MapGrid=Ext.extend(Ext.grid.GridPanel,{url:null,autoScroll:true,autoExpandColumn:'title',renderTo:"map-browser",height:300,createMapText:"UT:Create Map",exportMapText:"UT: Export Map",mapAbstractLabelText:"UT:Abstract",mapContactLabelText:"UT:Contact",mapGridText:"UT:Map",mapLinkLabelText:"UT:View this Map",mapTitleLabelText:"UT:Title",openMapText:"UT:Open Map",initComponent:function(){this.title=this.mapGridText;this.store=this.store||new Ext.data.JsonStore({url:this.url,root:'maps',id:'id',fields:[{name:'id',mapping:'id'},{name:"title",mapping:"config.about.title"},{name:"abstract",mapping:"config.about.abstract"},{name:"contact",mapping:"config.about.contact"}],autoLoad:true});if(!this.expander){var tpl=new Ext.Template('<p><b>'+this.mapAbstractLabelText+':</b> {abstract}</p>'+'<p><a href="/maps/{id}">'+this.mapLinkLabelText+'</a></p>');this.expander=new Ext.grid.RowExpander({tpl:tpl});}
if(!this.plugins){this.plugins=this.expander;}
if(!this.cm){this.cm=new Ext.grid.ColumnModel([this.expander,{id:'title',header:this.mapTitleLabelText,dataIndex:'title',sortable:true,renderer:function(value,metaData,record){return"<a href='/maps/"+record.get('id')+"'>"+value+"</a>";}},{id:'contact',header:this.mapContactLabelText,dataIndex:'contact',width:250,sortable:true}]);}
var mapGrid=this;this.tbar=["->",new Ext.Button({text:this.openMapText,iconCls:"icon-open-map",handler:function(){var rec=mapGrid.getSelectionModel().getSelected();if(rec)
location.href="/maps/"+rec.id+".html";}}),new Ext.Button({text:this.exportMapText,iconCls:"icon-export",handler:function(){var rec=mapGrid.getSelectionModel().getSelected();if(rec)mapGrid.showExportWizard({map:rec.id});}})];this.listeners=Ext.applyIf(this.listeners||{},{"rowdblclick":function(grid,rowIndex,evt){var rec=grid.store.getAt(rowIndex);if(rec!=null){location.href="/maps/"+rec.id+".html?";}}});MapGrid.superclass.initComponent.call(this);},showExportWizard:function(mapid){new ExportWizard(mapid).show();}});Ext.namespace("GeoExplorer");GeoExplorer.CapabilitiesGrid=Ext.extend(Ext.grid.GridPanel,{store:null,cm:null,expander:null,mapPanel:null,url:null,autoExpandColumn:"title",nameHeaderText:"UT:Name",queryableHeaderText:"UT:Queryable",titleHeaderText:"UT:Title",initComponent:function(){if(!this.store){this.store=new GeoExt.data.WMSCapabilitiesStore({url:this.url+"?service=wms&request=GetCapabilities"});this.store.load();}
if(!this.expander){this.expander=new Ext.grid.RowExpander({tpl:new Ext.Template('<p><b>Abstract:</b> {abstract}</p>')});}
if(!this.plugins){this.plugins=this.expander;}
if(!this.cm){this.cm=new Ext.grid.ColumnModel([this.expander,{id:"title",header:this.titleHeaderText,dataIndex:"title",sortable:true},{header:this.nameHeaderText,dataIndex:"name",width:180,sortable:true},{header:this.queryableHeaderText,dataIndex:"queryable"}]);}
GeoExplorer.CapabilitiesGrid.superclass.initComponent.call(this);},addLayers:function(base){var sm=this.getSelectionModel();var records=sm.getSelections();var record,layer,newRecords=[];for(var i=0;i<records.length;i++){Ext.data.Record.AUTO_ID++;record=records[i].copy(Ext.data.Record.AUTO_ID);layer=record.get("layer").clone();record.data.layer=layer;var proj=new OpenLayers.Projection("EPSG:900913");var nativeBounds=record.get("bbox")[proj.getCode()];var llbounds=record.get("llbbox")||[-180,-90,180,90];var bounds=(nativeBounds&&OpenLayers.Bounds.fromArray(nativeBounds.bbox))||(OpenLayers.Bounds.fromArray(llbounds).transform(new OpenLayers.Projection("EPSG:4326"),proj));layer.restrictedExtent=bounds;layer.maxExtent=bounds;newRecords.push(record);}
if(newRecords.length){var index=this.mapPanel.layers.findBy(function(r){return r.get("layer")instanceof OpenLayers.Layer.Vector;});if(index!==-1){this.mapPanel.layers.insert(index,newRecords);}else{this.mapPanel.layers.add(newRecords);}}}});Ext.namespace("GeoExplorer");GeoExplorer.NewSourceWindow=Ext.extend(Ext.Window,{title:"Add New Server...",bodyStyle:"padding: 0px",width:300,closeAction:'hide',error:null,initComponent:function(){this.addEvents("server-added");this.urlTextField=new Ext.form.TextField({fieldLabel:"URL",width:240,msgTarget:"under",validator:OpenLayers.Function.bind(function(){return(this.error==null)?true:this.error;},this)});this.form=new Ext.form.FormPanel({items:[this.urlTextField],border:false,labelWidth:30,bodyStyle:"padding: 5px",autoWidth:true,autoHeight:true});this.bbar=[new Ext.Button({text:"Cancel",handler:function(){this.hide();},scope:this}),new Ext.Toolbar.Fill(),new Ext.Button({text:"Add Server",iconCls:"icon-addlayers",handler:function(){this.error=null;this.urlTextField.validate();this.fireEvent("server-added",this.urlTextField.getValue());},scope:this})];this.items=this.form;GeoExplorer.NewSourceWindow.superclass.initComponent.call(this);this.form.on("render",function(){this.loadMask=new Ext.LoadMask(this.form.getEl(),{msg:"Contacting Server..."});},this);this.on("hide",function(){this.error=null;this.urlTextField.validate();this.urlTextField.setValue("");this.loadMask.hide();},this);},setLoading:function(){this.loadMask.show();},setError:function(error){this.loadMask.hide();this.error=error;this.urlTextField.validate();}});